---
- hosts:
    - lxd-master
    - lxd-workers
  become: true
  gather_facts: true
  any_errors_fatal: true

  tasks:
    - name: Configure LXD
      block:
        - name: remove existing LXD Cluster before Install
          shell: 'snap remove lxd --purge'
        - name: update LXD to latest
          community.general.snap:
            name: lxd
            channel: latest
        - name: Install zfs utilities
          apt:
            name: zfsutils-linux
            state: present
        - name: Load zfs
          command: modprobe zfs
        - name: Enable LXD socket
          systemd:
            name: snap.lxd.daemon.unix.socket
            state: started
            enabled: yes
        - name: Add user to LXD group
          user:
            name: "{{ ansible_ssh_user }}"
            groups: lxd
            append: yes
    - name: Initialize LXD
      block:
        - name: Initialize LXD Master | copy master preseed
          ansible.builtin.template:
            src: ../playbooks/templates/master_conf.yml.j2
            dest: ~/master_conf.yml
            mode: '0644'
          when: inventory_hostname in groups['lxd-master']

        - name: Initialize LXD | LXD Master Init
          ansible.builtin.shell:
            chdir: ~/
            cmd: lxd init --preseed < master_conf.yml
          when: inventory_hostname in groups['lxd-master']

        - name: Broadcast the cluster's certificate to the workers
          block:
            - name: LXD info
              command: lxc info
              register: lxc_info
              run_once: true
              changed_when: false

            - name: LXD info fact
              set_fact:
                cert_info: "{{ lxc_info.stdout | from_yaml }}"
                cacheable: yes

        - name: Load LXD config
          set_fact:
            config: "{{ lookup('template', 'worker_conf.yml.j2') }}"

        - name: LXD init
          command: lxd init --preseed <
          args:
            stdin: "{{ config }}"
          when: inventory_hostname in groups['lxd-workers']

        - name: Initialize LXD | Prepare physical network
          command: lxc network create my-net --type=physical parent=br0 --target={{ inventory_hostname }}

        - name: Initialize LXD | Configure Physical network
          command: lxc network create my-net --type=physical
          when: inventory_hostname in groups['lxd-master']

        - name: Create Default Profile
          community.general.lxd_profile:
            merge_profile: true
            name: default
            state: present
            config:
              linux.kernel_modules: rbd,bridge,br_netfilter,ip_tables,ip6_tables,ip_vs,netlink_diag,nf_nat,overlay,xt_conntrack
              raw.lxc: "lxc.kmsg=1 lxc.aa_profile = unconfined\nlxc.cgroup.devices.allow = a\nlxc.mount.auto=proc:rw sys:rw\nlxc.cap.drop = "
              security.nesting: "true"
              security.privileged: "true"
            description: Default LXD Profile
            devices:
              eth0:
                nictype: physical
                parent: my-net
                type: nic
              root:
                path: /
                pool: local
                type: disk
