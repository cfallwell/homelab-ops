---
- hosts:
    - lxd-master
    - lxd-workers
  become: true
  gather_facts: true
  any_errors_fatal: true

  tasks:
    - name: Configure LXD
      block:
        - name: remove existing LXD Cluster before Install
          shell: 'snap remove lxd --purge'
        - name: update LXD to latest
          community.general.snap:
            name: lxd
            channel: latest
        - name: Install zfs utilities
          apt:
            name: zfsutils-linux
            state: present
        - name: Load zfs
          command: modprobe zfs
        - name: Enable LXD socket
          systemd:
            name: snap.lxd.daemon.unix.socket
            state: started
            enabled: true
        - name: Add usere to LXD group
          user:
            name: "{{ ansible_ssh_user }}"
            groups: lxd
            append: true
    - name: Initialize LXD | LXD init's
      block:
        - name: Load LXD config
          set_fact:
            mconfig: "{{ lookup('template', 'master_conf.yml.j2') }}"

        - name: LXD init
          command: lxd init --preseed <
          args:
            stdin: "{{ mconfig }}"
          when: inventory_hostname in groups['lxd-master']

        - name: Broadcast the cluster's certificate to the workers
          block:
            - name: LXD info
              command: lxc info
              register: lxc_info
              run_once: true
              changed_when: false

            - name: LXD info fact
              set_fact:
                cert_info: "{{ lxc_info.stdout | from_yaml }}"
                cacheable: true

        - name: Load LXD config
          set_fact:
            config: "{{ lookup('template', 'worker_conf.yml.j2') }}"

        - name: LXD init
          command: lxd init --preseed <
          args:
            stdin: "{{ config }}"
          when: inventory_hostname in groups['lxd-workers']

        - name: Create Kubernetes Profile
          community.general.lxd_profile:
            merge_profile: true
            name: k3s
            state: present
            config:
              linux.kernel_modules: rbd,bridge,br_netfilter,ip_tables,ip6_tables,ip_vs,netlink_diag,nf_nat,overlay,xt_conntrack,nf_conntrack,vxlan
              raw.lxc: "lxc.apparmor.profile = unconfined\nlxc.cgroup.devices.allow = a\nlxc.mount.auto=proc:rw sys:rw\nlxc.cap.drop = "
              limits.memory.swap: "false"
              limits.memory: "2GB"
              limits.cpu: "2"
              security.nesting: "true"
              security.privileged: "true"
            description: Kubernetes Profile
            devices:
              root:
                path: /
                pool: local
                type: disk
          when: inventory_hostname in groups['lxd-master']
