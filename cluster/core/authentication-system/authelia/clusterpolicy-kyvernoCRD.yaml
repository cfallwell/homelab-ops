apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: sync-authelia-db-secret
  annotations:
    policies.kyverno.io/title: Sync Authelia Database Secret
    policies.kyverno.io/category: Other
    policies.kyverno.io/subject: Secret
    policies.kyverno.io/description: >-
      This policy will copy secret generated by Crunchydata Postgres Operator
      named `pgo-cluster-pguser-authelia` into `authentication-system`
      namespace.
spec:
  generateExistingOnPolicyUpdate: true
  rules:
    - name: sync-authelia-db-secret
      match:
        any:
          - resources:
              kinds:
                - Secret
              namespaces:
                - default
              selector:
                matchLabels:
                  postgres-operator.crunchydata.com/pguser: authelia
      generate:
        apiVersion: v1
        kind: Secret
        name: "{{request.object.metadata.name}}"
        namespace: authentication-system
        synchronize: true
        clone:
          namespace: default
          name: "{{request.object.metadata.name}}"
